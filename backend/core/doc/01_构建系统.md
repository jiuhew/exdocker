# 构建系统（Windows 11 + Docker Desktop）

## 目标与技术栈

- 前端: React 18 + Vite + TypeScript（Node 22）
- 后端: Django 5.x + DRF（Python 3.12）
- 队列: Celery 5.x（Redis 7.4 作为 broker/result）
- 数据库: MySQL 8.4
- 反代: Nginx 1.27
- 编排: Docker Compose v2

## 宿主系统支持与迁移（Rocky/Win11 开发 → CentOS 7 部署）

- 支持矩阵：
  - Rocky/AlmaLinux 8/9：推荐开发/预发/生产宿主；Docker/Compose 生态新特性更佳。
  - CentOS 7：可用于部署；需 Docker CE + Compose v2，overlay2 与 firewalld 配置良好。
  - Windows 11：通过 Docker Desktop（WSL2）本地开发。

- 基础前提（宿主需满足）：
  - CPU 架构与镜像一致（通常 linux/amd64）。
  - 容器运行时可用：Docker CE 正常，Compose v2 可用。
  - 内核与存储驱动：首选 overlay2；CentOS 7 虽内核老，但本项目栈可运行。
  - 网络与防火墙：对外仅暴露 80/443；开发期可临时映射 3000/8000。

- 迁移流程（Rocky/CI → CentOS 7 摘要）：
  1. 在 Rocky 或 CI 构建镜像，打标签（如 `vX.Y.Z`），推送至镜像仓库。
  2. 在 CentOS 7 安装 Docker CE 与 Compose v2，并按需配置 `/etc/docker/daemon.json`（镜像加速/日志）。
  3. 拉取代码并准备 `.env.prod`；使用 `docker-compose.yml + compose.prod.yml` 启动。
  4. 初始化：`docker compose exec backend python manage.py migrate && createsuperuser`。
  5. 仅通过 Nginx 暴露 80/443；开发端口不直接对公网开放。
  （详见《07_CentOS7_通过Git部署与运维.md》与《08_本地Dev与Linux生产环境联动体系.md》）

- Windows 11 开发要点：
  - 使用 Docker Desktop + WSL2；将仓库放在 WSL2 文件系统（性能更好）。
  - 配置 `.gitattributes` 强制脚本类文件使用 LF（避免容器内执行失败）。
  - 使用匿名卷挂载 `node_modules`；仅在本机暴露开发端口。

- 快速自检（目标机）：

```bash
docker version | cat
docker compose version | cat
docker info | grep -E 'Storage Driver|Cgroup'
uname -r
ss -lntp | cat
```

- 延伸阅读：
  - 《07_CentOS7_通过Git部署与运维.md》
  - 《08_本地Dev与Linux生产环境联动体系.md》

## 目录与关键文件

- `docker-compose.yml`: 定义所有服务与依赖关系、端口、卷、健康检查
- `backend/Dockerfile`: 构建后端镜像（纯 Python 依赖，不需要 apt）
- `frontend/Dockerfile`: 构建前端镜像（Vite dev server）
- `backend/requirements.txt`: 后端依赖（使用 PyMySQL + cryptography）
- `backend/core/__init__.py`: `pymysql.install_as_MySQLdb()` + 导出 `celery_app`
- `nginx/nginx.conf` 与 `nginx/conf.d/default.conf`: Nginx 配置与反代
- `docker/mysql/init.sql`: MySQL 初始化（UTF8MB4）
- `.env.example` → `.env`: 环境变量示例与实际配置

## 构建与启动（推荐步骤）

1. 复制环境

```bat
cd C:\workspace\react_explore
if not exist .env copy .env.example .env
```

1. 关闭 BuildKit（当前会话，避免代理导致的前端镜像拉取问题）并预拉基础镜像

```bat
set DOCKER_BUILDKIT=0
set COMPOSE_DOCKER_CLI_BUILD=0
docker pull python:3.12-slim
docker pull node:22-alpine
docker pull mysql:8.4
docker pull redis:7.4-alpine
docker pull nginx:1.27-alpine
```

1. 构建并启动

```bat
docker compose build
docker compose up -d
```

1. 验证

- 后端: <http://localhost:8000/api/health/>
- 前端: <http://localhost:3000>
- Celery 示例: <http://localhost:8000/api/common/add/?x=1&y=2>

## 一键脚本（PowerShell 概要）

见 `README.md` 或 `deploy.ps1` 示例：

- 复制 `.env`
- 关闭 BuildKit
- 预拉镜像
- `docker compose build && docker compose up -d`
- 健康检查与简单联通性探测

## 常见问题与规避

- 拉取超时/EOF：配置 registry mirrors（Docker Desktop → Docker Engine），或先 `docker pull`。
- BuildKit 拉取 `docker/dockerfile:1` 失败：关闭 BuildKit 或去掉 Dockerfile 语法行。
- MySQLdb 未找到/编译失败：改用 `PyMySQL`，并在 `core/__init__.py` 安装兼容层。
- MySQL 8 认证错误：安装 `cryptography`（已在 requirements），或改账户为 `mysql_native_password`。
- VS Code 不能 `docker logs`：将日志驱动设为 `json-file` 并重建容器。
